import vertexai
from vertexai.generative_models import GenerativeModel, SafetySetting
from src.utils.config import settings
import json
import logging

# Initialize Vertex AI
# We assume the environment is authenticated (via Cloud Run service account)
vertexai.init(project=settings.GCP_PROJECT_ID, location=settings.GCP_LOCATION)

SYSTEM_PROMPT = """
–¢—ã ‚Äî —Ü–∏–Ω–∏—á–Ω—ã–π, —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π –∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å–Ω—ã–π —Å—É–¥—å—è –≤ —á–∞—Ç–µ –¥—Ä—É–∑–µ–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∑–∞ –¥–µ–Ω—å, –≤—ã–±—Ä–∞—Ç—å "–°–Ω–∏—Ç—á–∞ –¥–Ω—è" (Snitch of the Day) –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –ø—Ä–æ—Å—Ç—É–ø–æ–∫ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –æ—á–∫–æ–≤.

–ö–ê–¢–ï–ì–û–†–ò–ò –ü–†–û–°–¢–£–ü–ö–û–í –ò –û–ß–ö–ò:
1. Whining (–ù—ã—Ç—å–µ) ‚Äî 10 –æ—á–∫–æ–≤. (–ñ–∞–ª–æ–±—ã –Ω–∞ –∂–∏–∑–Ω—å, —Ä–∞–±–æ—Ç—É, –ø–æ–≥–æ–¥—É).
2. Stiffness (–î—É—Ö–æ—Ç–∞) ‚Äî 15 –æ—á–∫–æ–≤. (–ó–∞–Ω—É–¥—Å—Ç–≤–æ, –ø—Ä–∏–¥–∏—Ä–∫–∏, –ø–∞—Å—Å–∏–≤–Ω–∞—è –∞–≥—Ä–µ—Å—Å–∏—è).
3. Cringe (–ö—Ä–∏–Ω–∂) ‚Äî 20 –æ—á–∫–æ–≤. (–ù–µ—É–¥–∞—á–Ω—ã–µ —à—É—Ç–∫–∏, —Å—Ç—Ä–∞–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –∏—Å–ø–∞–Ω—Å–∫–∏–π —Å—Ç—ã–¥).
4. Toxicity (–¢–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å) ‚Äî 25 –æ—á–∫–æ–≤. (–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, –≥—Ä—É–±–æ—Å—Ç—å, –∞–≥—Ä–µ—Å—Å–∏—è).
5. Betrayal (–ü—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ) ‚Äî 50 –æ—á–∫–æ–≤.
   - –ñ–µ—Å—Ç–∫–∏–µ —Å–ø–æ–π–ª–µ—Ä—ã –∫ —Ñ–∏–ª—å–º–∞–º/–∏–≥—Ä–∞–º (–±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è).
   - –°–ª–∏–≤ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Å–∫—Ä–∏–Ω—à–æ—Ç—ã –õ–°, —Ç–∞–π–Ω—ã).
   - –ù–∞—Ä—É—à–µ–Ω–∏–µ –î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π (—Å–º. —Å–ø–∏—Å–æ–∫ ACTIVE AGREEMENTS –Ω–∏–∂–µ).

–û–°–û–ë–´–ï –ü–†–ê–í–ò–õ–ê:
1. –†–ï–ê–ö–¶–ò–ò –ò –°–¢–ò–ö–ï–†–´:
   - –í –ª–æ–≥–∞—Ö –º–æ–≥—É—Ç –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è –∑–∞–ø–∏—Å–∏ –≤–∏–¥–∞ `[REACTION] User reacted ü§° to ...`.
   - –†–µ–∞–∫—Ü–∏—è ü§° (–∫–ª–æ—É–Ω) –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –æ–∑–Ω–∞—á–∞–µ—Ç "Toxicity" (–ø–∞—Å—Å–∏–≤–Ω–∞—è –∞–≥—Ä–µ—Å—Å–∏—è) –∏–ª–∏ "Stiffness" (–¥—É—Ö–æ—Ç–∞), –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –Ω–µ –∫ –º–µ—Å—Ç—É.
   - –ó–∞–ø–∏—Å–∏ –≤–∏–¥–∞ `[STICKER] ü§°` –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ —Å–º—ã—Å–ª—É —ç–º–æ–¥–∑–∏.

2. –î–ï–¢–ï–ö–¶–ò–Ø –ò–ì–ù–û–†–ê (Ignore Detection):
   - –ï—Å–ª–∏ User A –æ–±—Ä–∞—Ç–∏–ª—Å—è –∫ User B (—Ç–µ–≥, –∏–º—è –∏–ª–∏ —è–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å), –∏ User B –ø–∏—Å–∞–ª –¥—Ä—É–≥–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ, –Ω–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª –æ–±—Ä–∞—â–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ.
   - –í–ê–ñ–ù–û: –û—Ç–≤–µ—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –±–µ–∑ —Ä–µ–ø–ª–∞—è (reply) –∏–ª–∏ —Ç–µ–≥–∞. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–º—ã—Å–ª: –µ—Å–ª–∏ User B –æ—Ç–≤–µ—Ç–∏–ª –ø–æ —Ç–µ–º–µ –∏–ª–∏ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª ‚Äî —ç—Ç–æ –ù–ï –Ω–∞—Ä—É—à–µ–Ω–∏–µ.
   - –ù–∞—Ä—É—à–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –∞–∫—Ç–∏–≤–Ω–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–∏—Å–∞–ª –≤ —á–∞—Ç, –Ω–æ "–Ω–µ –∑–∞–º–µ—Ç–∏–ª" –≤–æ–ø—Ä–æ—Å–∞). –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –≤–æ–æ–±—â–µ –º–æ–ª—á–∞–ª ‚Äî –Ω–µ —à—Ç—Ä–∞—Ñ–æ–≤–∞—Ç—å.

3. –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –ü–û –û–°–ö–û–†–ë–õ–ï–ù–ò–Ø–ú:
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å–∫–æ—Ä–±–ª—è–µ—Ç –∏–ª–∏ –æ–±—Å—É–∂–¥–∞–µ—Ç —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä–æ–≥–æ –ù–ï–¢ –≤ —ç—Ç–æ–º —á–∞—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç—å, –ø–æ–ª–∏—Ç–∏–∫–∞, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–Ω–∞–∫–æ–º–æ–≥–æ –≤–Ω–µ —á–∞—Ç–∞), –æ—á–∫–∏ –∑–∞ –¢–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å –ù–ï –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è.
   - –ù–∞—á–∏—Å–ª—è–π –æ—á–∫–∏ —Ç–æ–ª—å–∫–æ –∑–∞ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞ (—Ç–µ—Ö, –∫—Ç–æ –µ—Å—Ç—å –≤ –ª–æ–≥–∞—Ö –∏–ª–∏ –∫ –∫–æ–º—É –æ–±—Ä–∞—â–∞—é—Ç—Å—è).

4. –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –£–ß–ê–°–¢–ù–ò–ö–û–í (–ù–∏–∫–Ω–µ–π–º—ã):
   - –£—á—Ç–∏, —á—Ç–æ –¥—Ä—É–∑—å—è –Ω–∞–∑—ã–≤–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –ø–æ –∫–ª–∏—á–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–∞–º–∏ –≤ –ª–æ–≥–∞—Ö.
   - –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:
     - –ï—Å–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø—Ä—è–º–æ–µ ("–≠–π, –õ—ã—Å—ã–π, —Ç—ã —á–µ–≥–æ..."), —Å—á–∏—Ç–∞–π "–õ—ã—Å–æ–≥–æ" —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —á–∞—Ç–∞.
     - –ï—Å–ª–∏ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –∏–¥–µ—Ç –≤ —Ç—Ä–µ—Ç—å–µ–º –ª–∏—Ü–µ ("–í–∏–¥–µ–ª, —á—Ç–æ –î—É—Ä–æ–≤ –Ω–∞–ø–∏—Å–∞–ª?"), –∏ —ç—Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –¥–∏–∞–ª–æ–≥–µ ‚Äî —Å—á–∏—Ç–∞–π –µ–≥–æ –≤–Ω–µ—à–Ω–∏–º –ª–∏—Ü–æ–º.
     - –ü—Ä–∏ —Å–æ–º–Ω–µ–Ω–∏—è—Ö: –ï—Å–ª–∏ –ø–æ—Ö–æ–∂–µ –Ω–∞ –¥—Ä—É–∂–µ—Å–∫—É—é –ø–µ—Ä–µ–ø–∞–ª–∫—É ‚Äî —Å—á–∏—Ç–∞–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–º. –ï—Å–ª–∏ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Å–ø–ª–µ—Ç–Ω–∏ ‚Äî –≤–Ω–µ—à–Ω–∏–º.

5. –ü–ê–ú–Ø–¢–¨ –ò –î–û–ì–û–í–û–†–ï–ù–ù–û–°–¢–ò (Agreements):
   - –¢–µ–±–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω —Å–ø–∏—Å–æ–∫ "ACTIVE AGREEMENTS" (–î–µ–π—Å—Ç–≤—É—é—â–∏–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏).
   - –ü—Ä–æ–≤–µ—Ä—å, –Ω–µ –Ω–∞—Ä—É—à–∏–ª –ª–∏ –∫—Ç–æ-—Ç–æ –∏–∑ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —ç—Ç–∏ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ —Ç–µ–∫—É—â–µ–º –ª–æ–≥–µ.
   - –ï—Å–ª–∏ –Ω–∞—Ä—É—à–∏–ª ‚Äî —ç—Ç–æ "Betrayal".
   - –¢–ê–ö–ñ–ï –ò–©–ò "IMPLICIT AGREEMENTS" (–ù–µ—è–≤–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏/–ü–ª–∞–Ω—ã):
     - –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ–∏–≥—Ä–∞—Ç—å ("–ì–æ –¥–æ—Ç–∞?", "–ë—É–¥—É –≤ CS —á–µ—Ä–µ–∑ —á–∞—Å") –∏–ª–∏ –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª –ø–æ–ª—É—á–µ–Ω –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.
     - –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —Å–æ–≥–ª–∞—Å–∏–ª—Å—è (–∏–ª–∏ —Å–∞–º –ø—Ä–µ–¥–ª–æ–∂–∏–ª –∏ –¥—Ä—É–≥–∏–µ —Å–æ–≥–ª–∞—Å–∏–ª–∏—Å—å), –Ω–æ –ø–æ—Ç–æ–º –ø—Ä–æ–ø–∞–ª/–Ω–µ –ø—Ä–∏—à–µ–ª –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è ‚Äî —ç—Ç–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ (Betrayal).
   - –¢–∞–∫–∂–µ –∏—â–∏ –ù–û–í–´–ï –Ø–í–ù–´–ï –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ ("–Ø –æ–±–µ—â–∞—é...", "–°–ø–æ—Ä–∏–º, —á—Ç–æ...", "–î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å: ...").
   - –ï—Å–ª–∏ –Ω–∞—à–µ–ª –Ω–æ–≤—É—é —è–≤–Ω—É—é –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å (–∫–æ—Ç–æ—Ä–∞—è –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ–ª—å—à–µ —á–µ–º –æ–¥–∏–Ω –¥–µ–Ω—å) ‚Äî –¥–æ–±–∞–≤—å –µ—ë –≤ —Å–ø–∏—Å–æ–∫ "new_agreements".

6. –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø –ò –ì–†–£–ü–ü–ò–†–û–í–ö–ê:
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–µ—Ç 10 —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥ ‚Äî —ç—Ç–æ –û–î–ò–ù –ø—Ä–æ—Å—Ç—É–ø–æ–∫ (Whining), –∞ –Ω–µ 10. –ù–µ –¥—É–±–ª–∏—Ä—É–π –∑–∞–ø–∏—Å–∏.
   - –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–∑–Ω—ã–µ –≤–∏–¥—ã –Ω–∞—Ä—É—à–µ–Ω–∏–π (–∏ –ù—ã—Ç—å–µ, –∏ –¢–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å), –æ–±—ä–µ–¥–∏–Ω–∏ –∏—Ö –≤ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –≤ "offenders".
   - –í –ø–æ–ª–µ "category" —É–∫–∞–∂–∏ —Å–∞–º–æ–µ —Å–µ—Ä—å–µ–∑–Ω–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∏–ª–∏ –ø–µ—Ä–µ—á–∏—Å–ª–∏ –∏—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä "Toxicity + Whining").
   - –û—á–∫–∏ –ø—Ä–æ—Å—É–º–º–∏—Ä—É–π.
   - –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø –î–û–ì–û–í–û–†–ï–ù–ù–û–°–¢–ï–ô:
     - –°—Ä–∞–≤–Ω–∏ –Ω–æ–≤—ã–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ —Å–æ —Å–ø–∏—Å–∫–æ–º "ACTIVE AGREEMENTS".
     - –ï—Å–ª–∏ –ø–æ—Ö–æ–∂–∞—è –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ (–¥–∞–∂–µ –µ—Å–ª–∏ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –∏–Ω–∞—á–µ) ‚Äî –ù–ï –¥–æ–±–∞–≤–ª—è–π –µ—ë –≤ "new_agreements".
     - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ–±—Å—É–∂–¥–∞—é—Ç –∏–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç —Å—Ç–∞—Ä—É—é –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –ù–ï –Ω–æ–≤–∞—è –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å.

–¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
  "offenders": [
    {
      "user_id": 12345,
      "username": "nickname",
      "title": "–°–Ω–∏—Ç—á",
      "category": "Whining",
      "points": 10,
      "reason": "–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ. –ï—Å–ª–∏ –ø—Ä–æ—Å—Ç—É–ø–∫–æ–≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ ‚Äî –ø–µ—Ä–µ—á–∏—Å–ª–∏ –∏—Ö –∏ –ø—Ä–æ—Å—É–º–º–∏—Ä—É–π –æ—á–∫–∏.",
      "quote": "–¶–∏—Ç–∞—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è."
    }
  ],
  "new_agreements": [
     {
       "text": "Ivan promised not to drink beer",
       "users": ["Ivan"],
       "created_at": "YYYY-MM-DD"
     }
  ]
}

–í–ê–ñ–ù–û:
- –í–Ω–µ—Å–∏ –≤ —Å–ø–∏—Å–æ–∫ –í–°–ï–•, –∫—Ç–æ —Å–æ–≤–µ—Ä—à–∏–ª –Ω–∞—Ä—É—à–µ–Ω–∏—è.
- –ü–æ–ª–µ "title" –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–≤–Ω–æ "–°–Ω–∏—Ç—á".
- –ï—Å–ª–∏ –æ–¥–∏–Ω —é–∑–µ—Ä –Ω–∞—Ä—É—à–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, –æ–±—ä–µ–¥–∏–Ω–∏ —ç—Ç–æ –≤ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å: –ø—Ä–æ—Å—É–º–º–∏—Ä—É–π –æ—á–∫–∏ –∏ –æ–ø–∏—à–∏ –≤—Å–µ –ø—Ä–æ—Å—Ç—É–ø–∫–∏.
- –ï—Å–ª–∏ –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ–π –Ω–µ—Ç –≤–æ–æ–±—â–µ ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ "offenders": [].
- user_id –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º (–∏–∑ –ª–æ–≥–∞).
"""

REPORT_VALIDATION_PROMPT = """
–¢—ã ‚Äî —Å—Ç—Ä–æ–≥–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä "–°–Ω–∏—Ç—á-–±–æ—Ç–∞". –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º.

–ö–ê–¢–ï–ì–û–†–ò–ò (Violations):
1. Whining (–ù—ã—Ç—å–µ) - –∂–∞–ª–æ–±—ã.
2. Stiffness (–î—É—Ö–æ—Ç–∞) - –∑–∞–Ω—É–¥—Å—Ç–≤–æ.
3. Cringe (–ö—Ä–∏–Ω–∂) - —Å—Ç—ã–¥.
4. Toxicity (–¢–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å) - –∞–≥—Ä–µ—Å—Å–∏—è.
5. Betrayal (–ü—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ) - —Å–ª–∏–≤, —Å–ø–æ–π–ª–µ—Ä—ã, –Ω–∞—Ä—É—à–µ–Ω–∏–µ –æ–±–µ—â–∞–Ω–∏–π.

–í–ê–ñ–ù–û:
- –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `[STICKER] <emoji>`, –æ—Ü–µ–Ω–∏–≤–∞–π —Å–º—ã—Å–ª —ç—Ç–æ–≥–æ —ç–º–æ–¥–∑–∏/—Å—Ç–∏–∫–µ—Ä–∞.
- –ù–∞–ø—Ä–∏–º–µ—Ä, –∫–ª–æ—É–Ω (ü§°) –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å—é.
- –ò–≥–Ω–æ—Ä–∏—Ä—É–π –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è —Ç—Ä–µ—Ç—å–∏—Ö –ª–∏—Ü, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –±–µ—Å–µ–¥–µ. –ù–∞—Ä—É—à–µ–Ω–∏–µ - —Ç–æ–ª—å–∫–æ –∞–≥—Ä–µ—Å—Å–∏—è –≤ –∞–¥—Ä–µ—Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤.

–¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å JSON:
{
  "valid": true/false,
  "category": "Whining" (–∏–ª–∏ null),
  "reason": "–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º"
}

–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ, —Å–º–µ—à–Ω–æ–µ (–≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ) –∏–ª–∏ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî —Å—Ç–∞–≤—å valid: false.
–ë—É–¥—å —Å—Ç—Ä–æ–≥. –ù–µ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ.
"""

async def validate_report(text):
    """
    Checks if a reported message is actually a violation.
    Returns: { valid: bool, category: str, reason: str }
    """
    if not text:
        return {"valid": False, "reason": "Empty message"}

    model = GenerativeModel("gemini-3-flash-preview")
    
    prompt = f"""
    –ü—Ä–æ–≤–µ—Ä—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è:
    "{text}"
    
    –í–µ—Ä–Ω–∏ JSON.
    """
    
    try:
        response = await model.generate_content_async(
            contents=[REPORT_VALIDATION_PROMPT, prompt],
            generation_config={"response_mime_type": "application/json"}
        )
        return json.loads(response.text)
    except Exception as e:
        logging.error(f"Error during report validation: {e}")
        return {"valid": False, "reason": "AI Error"}

async def analyze_daily_logs(logs, active_agreements=None):
    """
    Sends chat logs to Gemini and returns the winner analysis.
    active_agreements: list of dicts {text, created_at, ...}
    """
    if not logs:
        return None

    # Use the latest Flash model
    model = GenerativeModel("gemini-3-flash-preview")
    
    # Build context map (msg_id -> username) for replies
    # Note: message_id comes from doc.id which is string, reply_to is int
    id_map = {log.get('message_id'): log.get('username') for log in logs if log.get('message_id')}

    # Format logs into a readable string
    chat_history = "LOG START\n"
    for log in logs:
        # Check if timestamp is datetime or string (Firestore returns datetime)
        ts = log['timestamp']
        time_str = ts.strftime("%H:%M") if hasattr(ts, 'strftime') else str(ts)
        
        # Resolve reply context
        reply_context = ""
        reply_id = log.get('reply_to')
        if reply_id:
            target_user = id_map.get(str(reply_id))
            if target_user:
                reply_context = f" (replied to {target_user})"
            else:
                reply_context = " (reply)"
        
        chat_history += f"[{time_str}] {log['username']} (ID: {log['user_id']}){reply_context}: {log['text']}\n"
    chat_history += "LOG END"

    agreements_text = "–ù–µ—Ç –¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π."
    if active_agreements:
        agreements_text = ""
        for ag in active_agreements:
             ts = ag.get('created_at')
             date_str = ts.strftime("%Y-%m-%d") if hasattr(ts, 'strftime') else "Unknown"
             agreements_text += f"- {ag['text']} (–æ—Ç {date_str})\n"

    prompt = f"""
    ACTIVE AGREEMENTS (–ü—Ä–æ–≤–µ—Ä—å –Ω–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è):
    {agreements_text}
    
    –í–æ—Ç –ª–æ–≥ —á–∞—Ç–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è:
    {chat_history}
    
    –û–ø—Ä–µ–¥–µ–ª–∏ –°–Ω–∏—Ç—á–∞ –î–Ω—è —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–≤–æ–µ–π —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏. –ò—â–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –∏ –Ω–æ–≤—ã–µ –æ–±–µ—â–∞–Ω–∏—è. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON.
    """
    
    try:
        response = await model.generate_content_async(
            contents=[SYSTEM_PROMPT, prompt],
            generation_config={"response_mime_type": "application/json"}
        )
        
        logging.info(f"AI Response: {response.text}")
        return json.loads(response.text)
    except Exception as e:
        logging.error(f"Error during AI analysis: {e}")
        return None
