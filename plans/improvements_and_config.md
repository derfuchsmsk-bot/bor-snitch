# План улучшений и настройки бота

## 1. Рефакторинг конфигурации (src/utils/game_config.py)
В настоящее время некоторые системные настройки жестко закодированы в кодовой базе. Перенос их в `GameConfig` улучшит сопровождаемость кода.

### Новые параметры для добавления:
| Параметр | Значение | Описание |
|---|---|---|
| `AI_MODEL_ANALYSIS` | `"gemini-3-flash-preview"` | Модель для ежедневного анализа и комментариев |
| `AI_MODEL_MULTIMODAL` | `"gemini-3-pro-preview"` | Модель для транскрипции медиа |
| `TIMEZONE_OFFSET` | `3` | Смещение часов от UTC (для московского времени) |
| `MENTION_CHUNK_SIZE` | `50` | Макс. кол-во пользователей для тега в одном сообщении `/all` |
| `REPORT_NEXT_CONTEXT_LIMIT` | `5` | Кол-во будущих сообщений для контекста репорта |
| `ANALYSIS_CUTOFF_HOUR` | `4` | Час, когда решается, анализировать "вчера" или "сегодня" |

## 2. Улучшения логики мышления (ИИ)
Текущая логика ИИ функциональна, но может быть оптимизирована для большей точности и "характера".

### A. Внедрение Chain of Thought (CoT)
**Проблема:** ИИ сразу выдает JSON-вердикт. Это часто приводит к "галлюцинациям" нарушений или упущению нюансов (например, сарказма).
**Решение:** Изменить промпт, чтобы требовать фазу "черновика" или "мышления" перед выводом JSON.
*   **Действие:** Обновить `SYSTEM_PROMPT`, запросив:
    ```
    THOUGHT PROCESS:
    1. Analyze user X: Did they complain? Is it irony?
    2. Analyze user Y: Is their silence ignoring or just offline?
    ...
    FINAL JSON: { ... }
    ```
*   **Преимущество:** значительно снижает количество ложных срабатываний.

### B. Промпт-инжиниринг с XML-тегами
**Проблема:** Текущий промпт представляет собой большой блок текста.
**Решение:** Использовать XML-теги для структурирования (Gemini предпочитает это).
*   Структура: `<role>`, `<lore>`, `<rules>`, `<categories>`, `<output_format>`.

### C. Обогащение контекста
**Проблема:** Временные метки — это просто "HH:MM".
**Решение:**
*   Добавить **день недели** в контекст (например, "Понедельник, 23:50"). Это помогает различать контекст "вечер пятницы" и "утро понедельника".
*   Четко добавить индикатор **глубины ответа** (например, `[Reply to MsgID: 123]`).

## 3. Улучшения логики бота (Workflow)

### A. "Умные" циничные комментарии
**Проблема:** Комментарии чисто случайные (`0.5%`).
**Решение:** Реализовать вероятность на основе "триггеров".
*   **Логика:**
    *   Базовый шанс: 0.5%
    *   Если сообщение содержит "bot", "snitch", "ai": +10% шанс.
    *   Если длина сообщения > 200 символов (нытье): +2% шанс.
    *   Если у пользователя > 100 очков (он "цель"): +1% шанс.

### B. Логика валидации репортов
**Проблема:** `validate_report` получает контекст, но плохо видит, "кто начал", если лимит контекста мал.
**Решение:** Убедиться, что окно контекста центрируется *вокруг* отрепорченного сообщения более щедро (например, 20 до, 5 после). (Частично реализовано, но сделать настраиваемым).

## 4. Улучшения структуры кода

### A. Вынос промптов в `src/utils/prompts.py`
*   Вынести `SYSTEM_PROMPT` и `REPORT_VALIDATION_PROMPT` из `src/services/ai.py`.
*   Это позволяет редактировать "Мозг" без изменения "Тела" (логики).

### B. Вынос сообщений в `src/utils/messages.py`
*   Вынести статические строки (победа/проигрыш в казино, текст правил, текст помощи) в отдельный файл.

## 5. План реализации (Roadmap)

1.  [ ] **Обновить конфиг**: Добавить определенные параметры в `src/utils/game_config.py`.
2.  [ ] **Вынести промпты**: Создать `src/utils/prompts.py` с XML-структурированными промптами.
3.  [ ] **Рефакторинг AI Service**:
    *   Импортировать промпты из `utils`.
    *   Реализовать парсинг CoT (отрезать мыслительный процесс перед парсингом JSON).
    *   Использовать конфиг для моделей и лимитов.
4.  [ ] **Рефакторинг хендлеров**:
    *   Использовать конфиг для часового пояса и лимитов.
    *   Обновить `/all`, чтобы использовать лимит из конфига.
5.  [ ] **Улучшить комментарии**: Реализовать логику шансов на основе триггеров в `handle_messages`.
