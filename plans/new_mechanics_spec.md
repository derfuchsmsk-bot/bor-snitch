# Спецификация новых механик (v2)

Этот документ описывает техническое задание на внедрение двух новых игровых механик: «Гэмблинг» и «Штрафы за ложные доносы».

---

## 1. Гэмблинг (Рулетка)

Пользователи получают возможность один раз в сутки испытать удачу, чтобы снизить свой счетчик очков (или усугубить положение).

### Пользовательский сценарий
1. Пользователь отправляет команду `/casino`.
2. **Проверка доступности:**
   - Если пользователь уже играл сегодня (ДАТА И ВРЕМЯ ПО МОСКВЕ), бот отвечает: *"Ты уже лудил сегодня, додеп только завтра."*
   - Если доступно:
3. **Розыгрыш:** Бот "бросает монетку" (шанс 50/50).
4. **Результат:**
   - **Победа (Win):** "ЗАНОС!" -> Снимается **50** очков с общего счета (не уходя в минус).
   - **Поражение (Loss):** "АХХАХАХАХАХ ЛОХ ЕБАНЫЙ, А ДОДЕПНУТЬ НЕ ПОЛУЧИТСЯ АХАХАХАХХА!" -> Начисляется **+75** очков к общему счету.
5. Бот отправляет сообщение с результатом и новым балансом очков.

### Техническая реализация

#### Изменения в БД (`src/services/db.py`)
В коллекцию `user_stats` добавить поле:
- `last_gamble_date` (String, format "YYYY-MM-DD"): Дата последней игры.

#### Новые константы (`src/utils/game_config.py`)
```python
GAMBLE_WIN_POINTS = 50   # Сколько снимаем
GAMBLE_LOSS_POINTS = 75  # Сколько накидываем
```

#### Логика (`src/bot/handlers.py`)
- Добавить хендлер для команды `/roulette`.
- Получить текущую дату (UTC).
- Сравнить с `last_gamble_date` из профиля.
- Реализовать логику `random.choice([True, False])`.
- Обновить `total_points` и `last_gamble_date` в БД.
- Пересчитать ранг (`calculate_rank`) и обновить его.

---

## 2. Штрафы за ложные доносы (Клевета)

Вводится накопительная система штрафов за использование команды `/report` на сообщениях, которые AI не считает нарушениями.

### Пользовательский сценарий
1. Пользователь делает реплай `/report`.
2. AI анализирует сообщение.
3. **Сценарий валидного репорта:** Всё работает как раньше (репорт принимается).
4. **Сценарий ложного репорта (AI отклоняет):**
   - Бот отвечает стандартным отказом ("Это не масть...").
   - В фоне увеличивается скрытый счетчик ложных доносов (`false_report_count`).
   - **Проверка кратно 3:** Если это 3-й, 6-й, 9-й и т.д. ложный донос:
     - Бот дополнительно сообщает: *"Ты конкретный снитч: +25 очков."*
     - Баланс пользователя увеличивается на **25**.

### Техническая реализация

#### Изменения в БД (`src/services/db.py`)
В коллекцию `user_stats` добавить поле:
- `false_report_count` (Integer, default 0): Счетчик отклоненных репортов.

Необходимо создать метод (или обновить существующий) для атомарного обновления этого счетчика.

#### Новые константы (`src/utils/game_config.py`)
```python
FALSE_REPORT_LIMIT = 3    # Каждые N репортов
FALSE_REPORT_PENALTY = 25 # Штраф
```

#### Логика (`src/bot/handlers.py`)
- В функции `cmd_report`, в ветке `else` (где `result.get("valid")` is False):
  - Вызвать метод БД для инкремента `false_report_count`.
  - Проверить, делится ли новый count на 3 без остатка.
  - Если да: начислить штрафные очки и уведомить пользователя.

---

## План работ

1. [ ] **Config:** Добавить константы в `src/utils/game_config.py`.
2. [ ] **DB Service:** 
   - Обновить методы работы с `user_stats` для поддержки `last_gamble_date` и `false_report_count`.
   - Реализовать логику обновления очков "на лету" (без ожидания ночного пересчета) для этих механик.
3. [ ] **Handlers:** 
   - Реализовать команду `/roulette`.
   - Добавить логику штрафов в `/report`.
4. [ ] **Testing:** Проверить работу кулдауна (смена даты) и накопление штрафов.
