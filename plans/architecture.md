# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Snitch Bot (–°–Ω–∏—Ç—á-–±–æ—Ç)

## 1. –û–±–∑–æ—Ä
Telegram-–±–æ—Ç –¥–ª—è –¥—Ä—É–∂–µ—Å–∫–∏—Ö —á–∞—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–∫—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤—ã–±–∏—Ä–∞–µ—Ç "–°–Ω–∏—Ç—á–∞ –¥–Ω—è" (–≥–ª–∞–≤–Ω–æ–≥–æ –º—É–¥–∞–∫–∞/—É–µ–±–∞–Ω–∞) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AI. –¢–∞–∫–∂–µ –≤–µ–¥–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –Ω–µ–¥–µ–ª—é –∏ –º–µ—Å—è—Ü.

## 2. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
*   **–Ø–∑—ã–∫:** Python 3.11+
*   **–§—Ä–µ–π–º–≤–æ—Ä–∫:** Aiogram 3.x (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)
*   **–•–æ—Å—Ç–∏–Ω–≥:** Google Cloud Run (Containerized application)
*   **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** Google Cloud Firestore (NoSQL)
*   **AI Engine:** Vertex AI (Gemini 1.5 Flash / 2.0 Flash)
*   **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫:** Google Cloud Scheduler (–¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –¥–∂–æ–±)

## 3. –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã (Data Flow)

### A. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (Real-time)
```mermaid
sequenceDiagram
    participant User as User (Telegram)
    participant TG as Telegram API
    participant Bot as Cloud Run (Bot Service)
    participant DB as Firestore

    User->>TG: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
    TG->>Bot: Webhook Update
    Bot->>Bot: –ü—Ä–æ–≤–µ—Ä–∫–∞ (—ç—Ç–æ —Ç–µ–∫—Å—Ç? —ç—Ç–æ –Ω—É–∂–Ω—ã–π —á–∞—Ç?)
    Bot->>DB: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (Log)
    Note over DB: Collection: chat_logs/{chat_id}/{date}/{msg_id}
```

### B. –ê–Ω–∞–ª–∏–∑ "–°–Ω–∏—Ç—á–∞ –¥–Ω—è" (Daily Job)
```mermaid
sequenceDiagram
    participant Scheduler as Cloud Scheduler
    participant Bot as Cloud Run (Bot Service)
    participant DB as Firestore
    participant AI as Vertex AI (Gemini)
    participant TG as Telegram API

    Scheduler->>Bot: POST /analyze_daily
    Bot->>DB: –ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24—á
    DB-->>Bot: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (JSON)
    Bot->>AI: Prompt + Chat History
    Note over AI: –ê–Ω–∞–ª–∏–∑ —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏, –Ω—ã—Ç—å—è, –ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞
    AI-->>Bot: –ò–º—è —é–∑–µ—Ä–∞ + –ü—Ä–∏—á–∏–Ω–∞ + –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ
    Bot->>DB: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –≤ stats
    Bot->>TG: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç ("üèÜ –°–Ω–∏—Ç—á –¥–Ω—è...")
```

## 4. –°—Ö–µ–º–∞ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö (Firestore)

### Collection: `chats`
–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ `chat_id`.
*   `active`: boolean
*   `settings`: Map (—è–∑—ã–∫, —É—Ä–æ–≤–µ–Ω—å —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏ –∏ —Ç.–¥.)

### Collection: `logs` (Sub-collection inside `chats` or root with `chat_id` field)
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —á—Ç–µ–Ω–∏–π/–∑–∞–ø–∏—Å–∏: `chats/{chat_id}/daily_logs/{date_string}`
–í–Ω—É—Ç—Ä–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –º–∞—Å—Å–∏–≤ `messages`:
```json
{
  "messages": [
    {
      "user_id": 12345,
      "username": "ivan_durak",
      "text": "–Ω–µ–Ω–∞–≤–∏–∂—É –≤–∞—Å –≤—Å–µ—Ö",
      "timestamp": "2024-05-20T10:00:00Z",
      "reply_to": 67890
    }
  ]
}
```
*–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: Firestore –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç 1MB –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç. –ï—Å–ª–∏ —á–∞—Ç –æ—á–µ–Ω—å –∞–∫—Ç–∏–≤–Ω—ã–π, –ø—Ä–∏–¥–µ—Ç—Å—è —Ä–∞–∑–±–∏–≤–∞—Ç—å –Ω–∞ —à–∞—Ä–¥—ã (sharding) –∏–ª–∏ –ø–∏—Å–∞—Ç—å –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º (–¥–æ—Ä–æ–∂–µ).*
*–†–µ—à–µ–Ω–∏–µ:* –ü–∏—à–µ–º –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º –≤ `chats/{chat_id}/messages/`. TTL (Time-to-Live) policy —É–¥–∞–ª—è–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ 3 –¥–Ω—è.

### Collection: `stats`
`chats/{chat_id}/stats/{user_id}`
*   `snitch_count_day`: int
*   `snitch_count_week`: int
*   `snitch_count_month`: int
*   `last_win_date`: timestamp
*   `titles`: array ["–ì–ª–∞–≤–Ω—ã–π –Ω—ã—Ç–∏–∫", "–ö—Ä—ã—Å–∞"]

## 5. –ü—Ä–æ–º–ø—Ç –¥–ª—è Gemini (–ö–æ–Ω—Ü–µ–ø—Ç)
**System Prompt:**
> –¢—ã ‚Äî —Ü–∏–Ω–∏—á–Ω—ã–π, —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π –∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å–Ω—ã–π —Å—É–¥—å—è –≤ —á–∞—Ç–µ –¥—Ä—É–∑–µ–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∑–∞ –¥–µ–Ω—å –∏ –≤—ã–±—Ä–∞—Ç—å "–°–Ω–∏—Ç—á–∞ –¥–Ω—è" (Snitch of the Day).
>
> –ö—Ä–∏—Ç–µ—Ä–∏–∏:
> 1. –ö—Ç–æ –±–æ–ª—å—à–µ –≤—Å–µ—Ö –Ω—ã–ª?
> 2. –ö—Ç–æ –ø–æ–¥—Å—Ç–∞–≤–∏–ª –¥—Ä—É–≥–∞ –∏–ª–∏ "—Å–¥–∞–ª" –µ–≥–æ?
> 3. –ö—Ç–æ –±—ã–ª —Ç–æ–∫—Å–∏—á–Ω—ã–º –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã?
> 4. –ö—Ç–æ –ø–æ—Å—Ç–∏–ª –∫—Ä–∏–Ω–∂?
> 5. –ù–∞—Ä—É—à–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –∏ –æ–ø–æ–∑–¥–∞–Ω–∏—è.
> 6. –ò–≥–Ω–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π (read but no reply) –ø—Ä–∏ –ø—Ä—è–º–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏.
>
> –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
> 1. –ò–º—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (username).
> 2. –¢–∏—Ç—É–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ì–µ—Ä—Ü–æ–≥ –î—É—Ö–æ—Ç—ã").
> 3. –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ (—Å–º–µ—à–Ω–æ–µ –∏ –æ–±–∏–¥–Ω–æ–µ, 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
>
> –ù–µ –±—É–¥—å —Å–ª–∏—à–∫–æ–º –≤–µ–∂–ª–∏–≤—ã–º. –≠—Ç–æ —á–∞—Ç –¥—Ä—É–∑–µ–π, –æ–Ω–∏ –ª—é–±—è—Ç –∂–µ—Å—Ç–∫–∏–π —é–º–æ—Ä.

## 6. –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
1.  **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ GCP:** –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç, –≤–∫–ª—é—á–∏—Ç—å API (Vertex AI, Firestore, Cloud Run, Cloud Build).
2.  **Bot Skeleton:** Aiogram, Webhook handler.
3.  **DB Layer:** –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —á—Ç–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏.
4.  **AI Layer:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Vertex AI SDK.
5.  **Scheduler:** –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞.
6.  **Deploy:** Dockerfile + deploy script.
