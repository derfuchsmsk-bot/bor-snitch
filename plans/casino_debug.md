# Отчет по проверке механики Казино

## Проблема
Поступило сообщение о подозрительно высоком винрейте: "3 из 3 выиграли". Требовалось проверить корректность работы генератора случайных чисел и логики начисления очков.

## Анализ кода

### 1. Логика рандома
В файле `src/bot/handlers.py` используется стандартная библиотека Python:
```python
is_win = random.choice([True, False])
```
Это обеспечивает честное распределение 50/50.

### 2. Вероятность
Вероятность выиграть 4 раза подряд составляет:
$$ 0.5^4 = 0.0625 $$
То есть **6.25%** (или 1 случай из 16). Вероятность снижается, но остается статистически возможной.

Если эти выигрыши были получены одним пользователем в один день — это подтверждает гипотезу о **Race Condition** (см. ниже).

### 3. Начисление очков
Логика "победы" (уменьшение очков штрафа) и "поражения" (увеличение очков) реализована корректно в соответствии с концепцией "Снитча".

## Внесенные изменения

Для подтверждения работы алгоритма в реальном времени добавлено логирование в `src/bot/handlers.py`:
```python
logging.info(f"Casino roll for user {user_id} in chat {chat_id}: {'WIN' if is_win else 'LOSS'}")
```
Теперь в консоли можно будет точно отследить каждый бросок.

## Гипотезы и риски

### Race Condition (Состояние гонки)
Существует теоретическая уязвимость: если пользователь отправит команду `/casino` несколько раз за миллисекунды (спам), проверка `last_gamble_date` может пройти для всех запросов до того, как результат первого запишется в БД.

**Симптомы:** В логах будет несколько записей "Casino roll" для одного пользователя подряд.
**Решение (если подтвердится):** Внедрение транзакций или блокировок в Firestore.

## Заключение
Пользователь подтвердил, что выигрыши были получены **разными участниками**. Это исключает техническую ошибку (Race Condition) и подтверждает, что серия из 4 побед (вероятность 6.25%) является результатом случайного распределения (Variance).

Код работает корректно. Логирование оставлено для контроля будущих ситуаций.
